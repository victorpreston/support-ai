name: Deploy to Production

on:
  push:
    branches: [dev]

jobs:
  promote-to-production:
    name: Promote Dev to Production
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Configure Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
      - name: Fast-forward master from dev
        run: |
          git checkout master
          git merge dev --ff-only
          git push origin master
          
  deploy:
    name: Deploy to Vercel
    runs-on: ubuntu-latest
    needs: promote-to-production
    
    steps:
      - uses: actions/checkout@v4
        with:
          ref: master
          
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Build project
        run: pnpm run build
        
      - name: Deploy to Vercel
        uses: vercel/action@v1
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          
      - name: Create deployment comment
        if: github.event_name == 'push'
        run: |
          echo "ðŸš€ Production deployment successful!" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— Live URL: https://your-domain.vercel.app" >> $GITHUB_STEP_SUMMARY